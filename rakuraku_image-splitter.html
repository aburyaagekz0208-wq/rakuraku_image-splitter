<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>ã‚‰ãã‚‰ãç”»åƒç¸¦åˆ†å‰²å› | ãƒ–ãƒ©ã‚¦ã‚¶ã§ç„¡æ–™ç”»åƒã‚¹ãƒ©ã‚¤ã‚¹</title>
    
    <meta name="description" content="ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ç”»åƒã‚’ç¸¦ã«æŒ‡å®šãƒ”ã‚¯ã‚»ãƒ«ã§åˆ†å‰²ã§ãã‚‹ç„¡æ–™ãƒ„ãƒ¼ãƒ«ã€‚ã‚¹ãƒãƒ›å¯¾å¿œã€ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ä»˜ãã€‚ã‚µãƒ¼ãƒãƒ¼ã«ç”»åƒã‚’é€ä¿¡ã—ãªã„ãŸã‚ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã‚‚å®‰å…¨ã§ã™ã€‚Webæ¼«ç”»ã®åˆ†å‰²ãªã©ã«æœ€é©ï¼">
    
    <meta property="og:title" content="ç”»åƒç¸¦åˆ†å‰²ãƒ„ãƒ¼ãƒ« | ãƒ–ãƒ©ã‚¦ã‚¶å®Œçµã®ç„¡æ–™ã‚¹ãƒ©ã‚¤ã‚µãƒ¼">
    <meta property="og:description" content="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã‚’ä»»æ„ã®ãƒ”ã‚¯ã‚»ãƒ«ã§ç¸¦åˆ†å‰²ã—ã€ä¸€æ‹¬ä¿å­˜ã§ãã‚‹ç„¡æ–™ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚">
    <meta property="og:type" content="website">
    
    <style>

        body { font-family: sans-serif; background-color: #f4f7f6; color: #333; padding: 20px; }
        .container { max-width: 650px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { font-size: 1.5rem; text-align: center; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .form-group:last-child { border-bottom: none; }
        label { display: block; font-weight: bold; margin-bottom: 8px; }
        input[type="file"], input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .cut-point-row { display: flex; align-items: center; margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 4px; }
        .cut-point-row label { margin-bottom: 0; margin-right: 15px; white-space: nowrap; font-weight: normal; width: 120px;}
        
        button { padding: 12px; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: background 0.3s; }
        .btn-primary { width: 100%; background-color: #007bff; color: white; margin-top: 10px; font-weight: bold;}
        .btn-primary:hover { background-color: #0056b3; }
        .btn-primary:disabled { background-color: #ccc; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; color: white; padding: 8px 15px; font-size: 0.9rem; margin-bottom: 15px;}
        .btn-secondary:hover { background-color: #5a6268; }

        .preview-container { text-align: center; border: 2px dashed #ccc; padding: 10px; background: #fafafa; border-radius: 4px; margin-bottom: 20px; position: relative;}
        
        /* --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ --- */
        #previewCanvas { 
            width: 100%; 
            height: auto; 
            display: block; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            cursor: crosshair; /* åŸºæœ¬ã¯åå­—ã‚«ãƒ¼ã‚½ãƒ« */
            touch-action: none; /* ã‚¹ãƒãƒ›ã§ç·šã‚’ãªãã£ãŸæ™‚ã«ç”»é¢ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã™ã‚‹ã®ã‚’é˜²ã */
        }
        
        #previewPlaceholder { color: #999; padding: 40px 0; }
        
        .info-text { font-size: 0.9rem; color: #007bff; font-weight: bold; margin-top: 5px; }
        .slice-heights-box { background: #e9ecef; padding: 10px; border-radius: 4px; font-size: 0.9rem; margin-top: 15px; line-height: 1.5; }
        .slice-heights-box span { display: inline-block; margin-right: 15px; color: #333; }

        #resultArea { margin-top: 40px; border-top: 3px solid #007bff; padding-top: 20px; display: none; }
        .result-item { margin-bottom: 30px; text-align: center; background: #fdfdfd; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .result-item img { max-width: 100%; height: auto; display: block; margin: 0 auto 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .download-btn { display: inline-block; background-color: #28a745; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .download-btn:hover { background-color: #218838; }
        
        .btn-warning { background-color: #ff9800; color: white; font-weight: bold; width: auto; padding: 12px 30px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-warning:hover { background-color: #e68a00; }
        .btn-warning:disabled { background-color: #ccc; box-shadow: none; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <h1>ã‚‰ãã‚‰ãç”»åƒç¸¦åˆ†å‰²å›</h1>
    
    <div class="form-group">
        <label for="imageInput">1. ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
        <input type="file" id="imageInput" accept="image/png, image/jpeg, image/webp">
        <div id="imageInfo" class="info-text"></div>
    </div>

    <div class="form-group" id="previewGroup" style="display: none;">
        <label>åˆ†å‰²ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆèµ¤ã„ç·šã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦èª¿æ•´ã§ãã¾ã™ï¼‰</label>
        <div class="preview-container">
            <div id="previewPlaceholder">ç”»åƒã¨åˆ†å‰²ç·šãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
            <canvas id="previewCanvas" style="display: none;"></canvas>
        </div>
    </div>

    <div class="form-group" id="splitCountGroup" style="display: none;">
        <label for="splitCount">2. åˆ†å‰²æ•°</label>
        <input type="number" id="splitCount" value="2" min="2" max="50">
    </div>

    <div class="form-group" id="cutPointsGroup" style="display: none;">
        <label>3. ã‚«ãƒƒãƒˆä½ç½®ã®ãƒ”ã‚¯ã‚»ãƒ«æ•°ã‚’æŒ‡å®š (px)</label>
        <button type="button" id="resetEvenBtn" class="btn-secondary">ğŸ”„ å‡ç­‰å‰²ã‚Šã«ãƒªã‚»ãƒƒãƒˆ</button>
        <div id="cutPointsContainer"></div>
        <div id="sliceHeightsDisplay" class="slice-heights-box"></div>
    </div>

    <button id="processBtn" class="btn-primary" disabled>åˆ†å‰²ã—ã¦ç”»åƒã‚’å‡ºåŠ›ã™ã‚‹</button>

    <div id="resultArea">
        <h2 style="text-align: center; color: #007bff;">åˆ†å‰²çµæœ</h2>
        <div style="text-align: center; margin-bottom: 20px;">
            <button id="downloadAllBtn" class="btn-warning" style="display: none;">ğŸ“¦ å‡ºåŠ›ã•ã‚ŒãŸç”»åƒã‚’ã™ã¹ã¦ä¸€æ‹¬ä¿å­˜</button>
        </div>
        <div id="resultContainer"></div>
    </div>
</div>

<script>
    let loadedImage = null;
    const imageInput = document.getElementById('imageInput');
    const imageInfo = document.getElementById('imageInfo');
    const splitCountInput = document.getElementById('splitCount');
    const cutPointsContainer = document.getElementById('cutPointsContainer');
    const previewCanvas = document.getElementById('previewCanvas');
    const previewCtx = previewCanvas.getContext('2d');
    const processBtn = document.getElementById('processBtn');
    const resetEvenBtn = document.getElementById('resetEvenBtn');
    const sliceHeightsDisplay = document.getElementById('sliceHeightsDisplay');
    
    const previewGroup = document.getElementById('previewGroup');
    const splitCountGroup = document.getElementById('splitCountGroup');
    const cutPointsGroup = document.getElementById('cutPointsGroup');
    
    const resultArea = document.getElementById('resultArea');
    const resultContainer = document.getElementById('resultContainer');
    const downloadAllBtn = document.getElementById('downloadAllBtn');

    // --- ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œç”¨ã®å¤‰æ•° ---
    let isDragging = false;
    let draggedLineIndex = -1;

    imageInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        try {
            loadedImage = await loadImage(file);
            imageInfo.textContent = `å…ƒã®ç”»åƒã®ã‚µã‚¤ã‚º: å¹… ${loadedImage.width}px / é«˜ã• ${loadedImage.height}px`;
            
            previewGroup.style.display = 'block';
            splitCountGroup.style.display = 'block';
            cutPointsGroup.style.display = 'block';
            resultArea.style.display = 'none';
            downloadAllBtn.style.display = 'none';
            processBtn.disabled = false;

            generateCutInputs();
        } catch (error) {
            console.error(error);
            alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
    });

    splitCountInput.addEventListener('input', () => {
        if (loadedImage) generateCutInputs();
    });

    resetEvenBtn.addEventListener('click', () => {
        if (loadedImage) generateCutInputs();
    });

    function calculateEvenCuts(totalHeight, count) {
        const baseHeight = Math.floor(totalHeight / count);
        const remainder = totalHeight % count;
        const cuts = [];
        let currentY = 0;

        for (let i = 1; i < count; i++) {
            const sliceHeight = baseHeight + (i <= remainder ? 1 : 0);
            currentY += sliceHeight;
            cuts.push(currentY);
        }
        return cuts;
    }

    function generateCutInputs() {
        cutPointsContainer.innerHTML = '';
        let count = parseInt(splitCountInput.value, 10);
        if (isNaN(count) || count < 2) count = 2;
        
        const totalHeight = loadedImage.height;
        const defaultCuts = calculateEvenCuts(totalHeight, count);

        defaultCuts.forEach((cutY, index) => {
            const row = document.createElement('div');
            row.className = 'cut-point-row';
            
            const label = document.createElement('label');
            label.textContent = `ä¸Šã‹ã‚‰ ${index + 1}æœ¬ç›®ã®ç·š:`;
            
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'cut-input';
            input.value = cutY;
            input.min = 1;
            input.max = totalHeight - 1;
            
            input.addEventListener('input', () => {
                drawPreview();
                updateSliceHeights();
            });

            row.appendChild(label);
            row.appendChild(input);
            cutPointsContainer.appendChild(row);
        });
        
        drawPreview();
        updateSliceHeights();
    }

    function drawPreview() {
        if (!loadedImage) return;

        previewCanvas.width = loadedImage.width;
        previewCanvas.height = loadedImage.height;
        previewCtx.drawImage(loadedImage, 0, 0);

        const inputs = document.querySelectorAll('.cut-input');
        previewCtx.strokeStyle = 'red';
        previewCtx.lineWidth = Math.max(3, Math.floor(loadedImage.width / 300)); 

        inputs.forEach(input => {
            const y = parseInt(input.value, 10);
            if (!isNaN(y) && y > 0 && y < loadedImage.height) {
                previewCtx.beginPath();
                previewCtx.moveTo(0, y);
                previewCtx.lineTo(loadedImage.width, y);
                previewCtx.stroke();
            }
        });

        document.getElementById('previewPlaceholder').style.display = 'none';
        previewCanvas.style.display = 'block';
    }

    function updateSliceHeights() {
        if (!loadedImage) return;
        const totalHeight = loadedImage.height;
        
        let cuts = Array.from(document.querySelectorAll('.cut-input'))
            .map(input => parseInt(input.value, 10))
            .filter(y => !isNaN(y) && y > 0 && y < totalHeight);
        
        cuts.push(0);
        cuts.push(totalHeight);
        cuts.sort((a, b) => a - b);
        cuts = [...new Set(cuts)];

        let html = '<strong>ã€å‡ºåŠ›ã•ã‚Œã‚‹å„ç”»åƒã®é«˜ã•ã€‘</strong><br>';
        for (let i = 0; i < cuts.length - 1; i++) {
            const height = cuts[i + 1] - cuts[i];
            html += `<span>${i + 1}æšç›®: <b>${height}px</b></span>`;
        }
        sliceHeightsDisplay.innerHTML = html;
    }

    // --- ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒåº§æ¨™ã‚’ç”»åƒã®å†…éƒ¨ãƒ”ã‚¯ã‚»ãƒ«ã«å¤‰æ›ã™ã‚‹é–¢æ•° ---
    function getPointerY(e) {
        const rect = previewCanvas.getBoundingClientRect();
        const scaleY = previewCanvas.height / rect.height; // è¡¨ç¤ºã‚µã‚¤ã‚ºã¨å®Ÿã‚µã‚¤ã‚ºã®æ¯”ç‡
        return (e.clientY - rect.top) * scaleY;
    }

    // --- ã‚«ãƒ¼ã‚½ãƒ«ãŒã©ã®ç·šã®è¿‘ãã«ã‚ã‚‹ã‹åˆ¤å®šã™ã‚‹é–¢æ•° ---
    function getHoveredLineIndex(y) {
        const inputs = Array.from(document.querySelectorAll('.cut-input'));
        const rect = previewCanvas.getBoundingClientRect();
        const scaleY = previewCanvas.height / rect.height;
        // ç”»é¢ä¸Šã§ã®ã€Œ15pxã€ã®ç¯„å›²ã‚’å½“ãŸã‚Šåˆ¤å®šã¨ã™ã‚‹ï¼ˆã©ã‚“ãªç”»åƒã‚µã‚¤ã‚ºã§ã‚‚åŒã˜æ“ä½œæ„Ÿã«ã™ã‚‹ãŸã‚ï¼‰
        const tolerance = 15 * scaleY; 

        for (let i = 0; i < inputs.length; i++) {
            const lineY = parseInt(inputs[i].value, 10);
            if (Math.abs(y - lineY) <= tolerance) {
                return i;
            }
        }
        return -1;
    }

    // --- ãƒ‰ãƒ©ãƒƒã‚°æ“ä½œã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š (PointerEvent ã‚’ä½¿ç”¨) ---
    previewCanvas.addEventListener('pointerdown', (e) => {
        if (!loadedImage) return;
        // ãƒã‚¦ã‚¹ãŒã‚­ãƒ£ãƒ³ãƒã‚¹å¤–ã«å‡ºã¦ã‚‚ãƒ‰ãƒ©ãƒƒã‚°ã‚’ç¶™ç¶šã§ãã‚‹ã‚ˆã†ã«ã‚­ãƒ£ãƒ—ãƒãƒ£
        previewCanvas.setPointerCapture(e.pointerId); 
        
        const y = getPointerY(e);
        const lineIndex = getHoveredLineIndex(y);
        
        if (lineIndex !== -1) {
            isDragging = true;
            draggedLineIndex = lineIndex;
            previewCanvas.style.cursor = 'ns-resize'; // ä¸Šä¸‹ãƒªã‚µã‚¤ã‚ºã‚«ãƒ¼ã‚½ãƒ«ã«å¤‰æ›´
        }
    });

    previewCanvas.addEventListener('pointermove', (e) => {
        if (!loadedImage) return;
        const y = getPointerY(e);

        if (isDragging && draggedLineIndex !== -1) {
            const inputs = Array.from(document.querySelectorAll('.cut-input'));
            let newY = Math.round(y);
            
            // ç·šåŒå£«ãŒäº¤å·®ã—ãªã„ã‚ˆã†ã«ã€ä¸Šä¸‹ã®ç·šã®ä½ç½®ã‚’èª¿ã¹ã¦é™ç•Œå€¤ã‚’è¨­å®šã™ã‚‹
            let minY = 1;
            let maxY = loadedImage.height - 1;
            
            if (draggedLineIndex > 0) {
                minY = parseInt(inputs[draggedLineIndex - 1].value, 10) + 1; // ä¸Šã®ç·šã‚ˆã‚Šä¸‹
            }
            if (draggedLineIndex < inputs.length - 1) {
                maxY = parseInt(inputs[draggedLineIndex + 1].value, 10) - 1; // ä¸‹ã®ç·šã‚ˆã‚Šä¸Š
            }
            
            // é™ç•Œå€¤ã®ç¯„å›²å†…ã«åº§æ¨™ã‚’åã‚ã‚‹
            newY = Math.max(minY, Math.min(newY, maxY));
            
            // å…¥åŠ›æ¬„ã®æ•°å€¤ã‚’æ›¸ãæ›ãˆã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨æƒ…å ±ã‚’æ›´æ–°
            inputs[draggedLineIndex].value = newY;
            drawPreview();
            updateSliceHeights();
            
        } else {
            // ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ã„ãªã„æ™‚ã¯ã€ç·šã®è¿‘ãã«ã‚«ãƒ¼ã‚½ãƒ«ãŒæ¥ãŸã‚‰å½¢ã‚’å¤‰ãˆã‚‹ï¼ˆãƒ›ãƒãƒ¼åŠ¹æœï¼‰
            const lineIndex = getHoveredLineIndex(y);
            previewCanvas.style.cursor = lineIndex !== -1 ? 'ns-resize' : 'crosshair';
        }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†å‡¦ç†
    const endDrag = (e) => {
        if(isDragging) {
            isDragging = false;
            draggedLineIndex = -1;
            previewCanvas.releasePointerCapture(e.pointerId);
            previewCanvas.style.cursor = 'crosshair';
        }
    };
    previewCanvas.addEventListener('pointerup', endDrag);
    previewCanvas.addEventListener('pointercancel', endDrag);

    // ç”»é¢å‡ºåŠ›å‡¦ç†
    processBtn.addEventListener('click', () => {
        if (!loadedImage) return;
        
        processBtn.disabled = true;
        processBtn.textContent = 'å‡¦ç†ä¸­...';
        resultContainer.innerHTML = ''; 
        
        setTimeout(() => {
            try {
                const width = loadedImage.width;
                const totalHeight = loadedImage.height;

                let cuts = Array.from(document.querySelectorAll('.cut-input'))
                    .map(input => parseInt(input.value, 10))
                    .filter(y => !isNaN(y) && y > 0 && y < totalHeight);
                
                cuts.push(0);
                cuts.push(totalHeight);
                cuts.sort((a, b) => a - b);
                cuts = [...new Set(cuts)];

                const workCanvas = document.createElement('canvas');
                const workCtx = workCanvas.getContext('2d');
                workCanvas.width = width;

                for (let i = 0; i < cuts.length - 1; i++) {
                    const startY = cuts[i];
                    const endY = cuts[i + 1];
                    const currentHeight = endY - startY;
                    
                    workCanvas.height = currentHeight;
                    workCtx.drawImage(loadedImage, 0, startY, width, currentHeight, 0, 0, width, currentHeight);
                    
                    const dataUrl = workCanvas.toDataURL('image/png');
                    const fileNumber = String(i + 1).padStart(2, '0');
                    const fileName = `image_${fileNumber}.png`;
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'result-item';
                    
                    const label = document.createElement('h3');
                    label.textContent = `${i + 1}æšç›® (${width}x${currentHeight}px)`;
                    label.style.marginTop = '0';
                    
                    const img = document.createElement('img');
                    img.src = dataUrl;
                    
                    const downloadBtn = document.createElement('a');
                    downloadBtn.href = dataUrl;
                    downloadBtn.download = fileName;
                    downloadBtn.className = 'download-btn individual-download-btn';
                    downloadBtn.textContent = `â¬‡ï¸ ${fileName} ã‚’ä¿å­˜`;

                    itemDiv.appendChild(label);
                    itemDiv.appendChild(img);
                    itemDiv.appendChild(downloadBtn);
                    resultContainer.appendChild(itemDiv);
                }

                resultArea.style.display = 'block';
                downloadAllBtn.style.display = 'inline-block';
                resultArea.scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error(error);
                alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'åˆ†å‰²ã—ã¦ç”»åƒã‚’å‡ºåŠ›ã™ã‚‹';
            }
        }, 50);
    });

    downloadAllBtn.addEventListener('click', async () => {
        const links = document.querySelectorAll('.individual-download-btn');
        if (links.length === 0) return;

        const confirmMsg = 'å‡ºåŠ›ã•ã‚ŒãŸå…¨ã¦ã®ç”»åƒã‚’é †ç•ªã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã€Œè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã®è¨±å¯ã‚’æ±‚ã‚ã‚‰ã‚ŒãŸå ´åˆã¯ã€Œè¨±å¯ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚\n\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ';
        if (!confirm(confirmMsg)) return;

        const originalText = downloadAllBtn.textContent;
        downloadAllBtn.disabled = true;
        downloadAllBtn.textContent = 'ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...';

        for (let i = 0; i < links.length; i++) {
            links[i].click();
            await new Promise(resolve => setTimeout(resolve, 500));
        }

        downloadAllBtn.textContent = 'âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼';
        
        setTimeout(() => {
            downloadAllBtn.disabled = false;
            downloadAllBtn.textContent = originalText;
        }, 3000);
    });

    function loadImage(file) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = reject;
            img.src = URL.createObjectURL(file);
        });
    }
</script>

</body>
</html>